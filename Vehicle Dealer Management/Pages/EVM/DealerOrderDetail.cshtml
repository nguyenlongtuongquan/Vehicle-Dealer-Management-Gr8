@page
@model Vehicle_Dealer_Management.Pages.EVM.DealerOrderDetailModel
@{
    ViewData["Title"] = $"Đơn đặt hàng #{Model.Order.Id}";
    ViewData["UserRole"] = "EVM_STAFF";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "EVM Staff";
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Đơn đặt hàng #@Model.Order.Id</h1>
            <p class="content-subtitle">Chi tiết và duyệt đơn</p>
        </div>
        <a href="/EVM/DealerOrders" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

<div class="grid grid-cols-3 gap-3">
    <!-- Left: Order Details -->
    <div style="grid-column: span 2;">
        <!-- Order Info -->
        <div class="card mb-3">
            <div class="card-header">
                <div class="flex justify-between items-center">
                    <h3 class="card-title mb-0">Thông tin đơn hàng</h3>
                    @await Html.PartialAsync("_StatusBadge", Model.Order.Status)
                </div>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <p class="text-muted mb-1">Đại lý</p>
                        <p class="mb-3"><strong style="font-size: 1.125rem;">@Model.Order.DealerName</strong></p>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Mã đại lý</p>
                        <p class="mb-3"><strong>@Model.Order.DealerCode</strong></p>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Ngày đặt</p>
                        <p class="mb-3">@Model.Order.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Người tạo</p>
                        <p class="mb-3">@Model.Order.CreatedByName</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Danh sách xe đặt hàng</h3>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mẫu xe</th>
                                <th>Màu sắc</th>
                                <th>Số lượng</th>
                                <th>Đơn giá (Sỉ)</th>
                                <th>Thành tiền</th>
                                <th>Tồn kho EVM</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Order.Items)
                            {
                                var hasEnoughStock = item.AvailableStock >= item.Quantity;
                                
                                <tr>
                                    <td><strong>@item.VehicleName</strong></td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 16px; height: 16px; border-radius: 50%; background: @GetColorHex(item.Color); border: 1px solid var(--border);"></div>
                                            @item.Color
                                        </div>
                                    </td>
                                    <td><strong style="font-size: 1.125rem;">@item.Quantity</strong></td>
                                    <td>@item.WholesalePrice.ToString("N0") VND</td>
                                    <td><strong style="color: var(--accent-cyan);">@item.Total.ToString("N0") VND</strong></td>
                                    <td>
                                        @if (hasEnoughStock)
                                        {
                                            <span style="color: var(--success);">
                                                <i class="bi bi-check-circle"></i> @item.AvailableStock
                                            </span>
                                        }
                                        else
                                        {
                                            <span style="color: var(--error);">
                                                <i class="bi bi-exclamation-triangle"></i> @item.AvailableStock (Thiếu)
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot style="background: var(--surface); border-top: 2px solid var(--border); font-weight: 600;">
                            <tr>
                                <td colspan="2">TỔNG CỘNG</td>
                                <td><strong>@Model.Order.Items.Sum(i => i.Quantity) xe</strong></td>
                                <td colspan="1"></td>
                                <td><strong style="color: var(--accent-cyan); font-size: 1.25rem;">@Model.Order.Items.Sum(i => i.Total).ToString("N0") VND</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Right: Actions & Timeline -->
    <div>
        <!-- Actions -->
        @if (Model.Order.Status == "SUBMITTED")
        {
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title mb-0">Xử lý đơn hàng</h3>
                </div>
                <div class="card-body">
                    @if (Model.HasEnoughStock)
                    {
                        <form method="post" asp-page-handler="Approve">
                            <input type="hidden" name="orderId" value="@Model.Order.Id" />
                            <button type="submit" class="btn btn-success btn-block mb-2">
                                <i class="bi bi-check-circle"></i> Duyệt đơn
                            </button>
                        </form>
                    }
                    else
                    {
                        <div style="background: var(--warning-bg); color: var(--warning); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1rem; font-size: 0.875rem;">
                            <i class="bi bi-exclamation-triangle"></i> Không đủ tồn kho để duyệt đơn
                        </div>
                    }
                    
                    <button class="btn btn-danger btn-block" onclick="document.getElementById('rejectModal').style.display='flex'">
                        <i class="bi bi-x-circle"></i> Từ chối đơn
                    </button>
                </div>
            </div>
        }

        <!-- Order Summary -->
        <div class="card mb-3">
            <div class="card-header">
                <h3 class="card-title mb-0">Tổng kết</h3>
            </div>
            <div class="card-body">
                <div class="flex justify-between mb-2">
                    <span class="text-muted">Tổng số xe:</span>
                    <strong style="font-size: 1.125rem;">@Model.Order.Items.Sum(i => i.Quantity) xe</strong>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-muted">Tổng giá trị:</span>
                    <strong style="color: var(--accent-cyan);">@Model.Order.Items.Sum(i => i.Total).ToString("N0") VND</strong>
                </div>
                <hr style="border-color: var(--border);" />
                <div class="flex justify-between">
                    <span class="text-muted">Trạng thái kho:</span>
                    @if (Model.HasEnoughStock)
                    {
                        <span style="color: var(--success);">
                            <i class="bi bi-check-circle"></i> Đủ hàng
                        </span>
                    }
                    else
                    {
                        <span style="color: var(--error);">
                            <i class="bi bi-exclamation-triangle"></i> Thiếu hàng
                        </span>
                    }
                </div>
            </div>
        </div>

        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">Lịch sử</h3>
            </div>
            <div class="card-body">
                <div style="border-left: 2px solid var(--border); padding-left: 1rem;">
                    <div class="mb-3">
                        <div style="color: var(--accent-cyan); font-weight: 600; margin-bottom: 0.25rem;">
                            <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Đơn được tạo
                        </div>
                        <div class="text-muted" style="font-size: 0.875rem;">
                            @Model.Order.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                        </div>
                        <div class="text-muted" style="font-size: 0.875rem;">
                            Bởi @Model.Order.CreatedByName
                        </div>
                    </div>
                    
                    @if (Model.Order.Status != "SUBMITTED" && Model.Order.Status != "DRAFT")
                    {
                        <div class="mb-3">
                            <div style="color: var(--success); font-weight: 600; margin-bottom: 0.25rem;">
                                <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> Đơn được duyệt
                            </div>
                            <div class="text-muted" style="font-size: 0.875rem;">
                                @(Model.Order.ApprovedAt?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reject Modal -->
<div id="rejectModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%;">
        <div class="card-header">
            <h3 class="card-title mb-0">Từ chối đơn hàng</h3>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="Reject">
                <input type="hidden" name="orderId" value="@Model.Order.Id" />
                <div class="form-group">
                    <label class="form-label">Lý do từ chối</label>
                    <textarea class="form-control" name="reason" rows="4" required placeholder="Nhập lý do từ chối đơn hàng..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-danger">Xác nhận từ chối</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('rejectModal').style.display='none'">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

@functions {
    string GetColorHex(string color)
    {
        return color.ToUpper() switch
        {
            "BLACK" => "#000000",
            "WHITE" => "#FFFFFF",
            "RED" => "#DC2626",
            "BLUE" => "#3B82F6",
            "GRAY" or "GREY" => "#6B7280",
            _ => "#94A3B8"
        };
    }
}

