@page
@model Vehicle_Dealer_Management.Pages.DealerManager.Reports.DebtsModel
@{
    ViewData["Title"] = "Báo cáo công nợ";
    ViewData["UserRole"] = "DEALER_MANAGER";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "Manager";
}

<div class="content-header">
    <h1 class="content-title">Báo cáo công nợ</h1>
    <p class="content-subtitle">Quản lý công nợ khách hàng và công nợ với hãng xe</p>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-4 mb-4">
    <div class="stat-card">
        <div class="flex justify-between items-center">
            <div class="stat-label">Công nợ khách hàng</div>
            <i class="bi bi-person-exclamation" style="font-size: 1.5rem; color: var(--error);"></i>
        </div>
        <div class="stat-value" style="color: var(--error);">@Model.TotalCustomerDebt.ToString("N0")</div>
        <div class="text-muted" style="font-size: 0.875rem;">@Model.OverdueCustomers khách quá hạn</div>
    </div>

    <div class="stat-card">
        <div class="flex justify-between items-center">
            <div class="stat-label">Công nợ với hãng</div>
            <i class="bi bi-building-exclamation" style="font-size: 1.5rem; color: var(--warning);"></i>
        </div>
        <div class="stat-value" style="color: var(--warning);">@Model.TotalEvmDebt.ToString("N0")</div>
        <div class="text-muted" style="font-size: 0.875rem;">@Model.OverdueEvmOrders đơn chưa thanh toán</div>
    </div>

    <div class="stat-card">
        <div class="flex justify-between items-center">
            <div class="stat-label">Đã thu trong tháng</div>
            <i class="bi bi-cash-coin" style="font-size: 1.5rem; color: var(--success);"></i>
        </div>
        <div class="stat-value" style="color: var(--success);">@Model.MonthlyCollected.ToString("N0")</div>
        <div class="text-muted" style="font-size: 0.875rem;">VND</div>
    </div>

    <div class="stat-card">
        <div class="flex justify-between items-center">
            <div class="stat-label">Tỷ lệ thu hồi</div>
            <i class="bi bi-percent" style="font-size: 1.5rem; color: var(--info);"></i>
        </div>
        <div class="stat-value">@Model.CollectionRate.ToString("F1")%</div>
        <div class="text-muted" style="font-size: 0.875rem;">Trong tháng</div>
    </div>
</div>

<!-- Tab Navigation -->
<div class="card mb-4">
    <div class="card-body" style="padding: 0;">
        <div style="display: flex; border-bottom: 1px solid var(--border);">
            <button class="tab-button active" onclick="showTab('customer')" id="tab-customer-btn" style="padding: 1rem 2rem; background: none; border: none; color: var(--text); cursor: pointer; border-bottom: 2px solid var(--accent-cyan);">
                <i class="bi bi-people"></i> Công nợ khách hàng
            </button>
            <button class="tab-button" onclick="showTab('evm')" id="tab-evm-btn" style="padding: 1rem 2rem; background: none; border: none; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent;">
                <i class="bi bi-building"></i> Công nợ với hãng
            </button>
        </div>
    </div>
</div>

<!-- Customer Debts Tab -->
<div id="customer-tab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h3 class="card-title mb-0">Danh sách công nợ khách hàng</h3>
                <div class="flex gap-2">
                    <select class="form-control" style="width: 200px;" onchange="filterCustomerDebts(this.value)">
                        <option value="all">Tất cả</option>
                        <option value="overdue">Quá hạn</option>
                        <option value="due-soon">Sắp đến hạn</option>
                    </select>
                    <button class="btn btn-secondary btn-sm">
                        <i class="bi bi-download"></i> Xuất Excel
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            @if (Model.CustomerDebts.Any())
            {
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Khách hàng</th>
                                <th>Số điện thoại</th>
                                <th>Mã đơn</th>
                                <th>Tổng đơn</th>
                                <th>Đã thanh toán</th>
                                <th>Còn nợ</th>
                                <th>Hạn thanh toán</th>
                                <th>Trạng thái</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var debt in Model.CustomerDebts)
                            {
                                var isOverdue = debt.DueDate < DateTime.Today;
                                var isDueSoon = debt.DueDate <= DateTime.Today.AddDays(7) && !isOverdue;
                                
                                <tr class="@(isOverdue ? "overdue" : "") @(isDueSoon ? "due-soon" : "")">
                                    <td>
                                        <div><strong>@debt.CustomerName</strong></div>
                                        <div class="text-muted" style="font-size: 0.875rem;">@debt.CustomerEmail</div>
                                    </td>
                                    <td>@debt.CustomerPhone</td>
                                    <td><strong>#@debt.OrderId</strong></td>
                                    <td>@debt.TotalAmount.ToString("N0") VND</td>
                                    <td style="color: var(--success);">@debt.PaidAmount.ToString("N0") VND</td>
                                    <td>
                                        <strong style="color: var(--error); font-size: 1.125rem;">
                                            @debt.DebtAmount.ToString("N0") VND
                                        </strong>
                                    </td>
                                    <td>
                                        @debt.DueDate.ToString("dd/MM/yyyy")
                                        @if (isOverdue)
                                        {
                                            <div style="color: var(--error); font-size: 0.875rem;">
                                                Quá hạn @((DateTime.Today - debt.DueDate).Days) ngày
                                            </div>
                                        }
                                        else if (isDueSoon)
                                        {
                                            <div style="color: var(--warning); font-size: 0.875rem;">
                                                Còn @((debt.DueDate - DateTime.Today).Days) ngày
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (isOverdue)
                                        {
                                            <span class="badge badge-error">Quá hạn</span>
                                        }
                                        else if (isDueSoon)
                                        {
                                            <span class="badge badge-warning">Sắp đến hạn</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-info">Đang theo dõi</span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="alert('Chức năng nhắc nợ - Coming soon')">
                                            <i class="bi bi-bell"></i> Nhắc nợ
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot style="background: var(--surface); border-top: 2px solid var(--border); font-weight: 600;">
                            <tr>
                                <td colspan="5">TỔNG CÔNG NỢ</td>
                                <td><strong style="color: var(--error); font-size: 1.25rem;">@Model.TotalCustomerDebt.ToString("N0") VND</strong></td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">✅</div>
                    <div class="empty-state-title">Không có công nợ khách hàng</div>
                    <div class="empty-state-text">Tất cả khách hàng đã thanh toán đầy đủ</div>
                </div>
            }
        </div>
    </div>
</div>

<!-- EVM Debts Tab -->
<div id="evm-tab" class="tab-content" style="display: none;">
    <div class="card">
        <div class="card-header">
            <div class="flex justify-between items-center">
                <h3 class="card-title mb-0">Công nợ với hãng xe (EVM)</h3>
                <button class="btn btn-secondary btn-sm">
                    <i class="bi bi-download"></i> Xuất Excel
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (Model.EvmDebts.Any())
            {
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Mã đơn đặt hàng</th>
                                <th>Ngày đặt</th>
                                <th>Số lượng xe</th>
                                <th>Tổng giá trị</th>
                                <th>Đã thanh toán</th>
                                <th>Còn nợ</th>
                                <th>Hạn thanh toán</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var debt in Model.EvmDebts)
                            {
                                var isOverdue = debt.DueDate < DateTime.Today;
                                
                                <tr>
                                    <td><strong>#@debt.OrderId</strong></td>
                                    <td>@debt.OrderDate.ToString("dd/MM/yyyy")</td>
                                    <td>@debt.VehicleCount xe</td>
                                    <td>@debt.TotalAmount.ToString("N0") VND</td>
                                    <td style="color: var(--success);">@debt.PaidAmount.ToString("N0") VND</td>
                                    <td>
                                        <strong style="color: var(--warning); font-size: 1.125rem;">
                                            @debt.DebtAmount.ToString("N0") VND
                                        </strong>
                                    </td>
                                    <td>
                                        @debt.DueDate.ToString("dd/MM/yyyy")
                                        @if (isOverdue)
                                        {
                                            <div style="color: var(--error); font-size: 0.875rem;">
                                                Quá hạn @((DateTime.Today - debt.DueDate).Days) ngày
                                            </div>
                                        }
                                    </td>
                                    <td>
                                        @if (isOverdue)
                                        {
                                            <span class="badge badge-error">Quá hạn</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-warning">Chưa thanh toán</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot style="background: var(--surface); border-top: 2px solid var(--border); font-weight: 600;">
                            <tr>
                                <td colspan="5">TỔNG CÔNG NỢ VỚI HÃNG</td>
                                <td><strong style="color: var(--warning); font-size: 1.25rem;">@Model.TotalEvmDebt.ToString("N0") VND</strong></td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon">✅</div>
                    <div class="empty-state-title">Không có công nợ với hãng</div>
                    <div class="empty-state-text">Đại lý đã thanh toán đầy đủ cho hãng xe</div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.style.color = 'var(--text-muted)';
                btn.style.borderBottom = '2px solid transparent';
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            const btn = document.getElementById('tab-' + tabName + '-btn');
            btn.style.color = 'var(--text)';
            btn.style.borderBottom = '2px solid var(--accent-cyan)';
            btn.classList.add('active');
        }
        
        function filterCustomerDebts(filter) {
            const rows = document.querySelectorAll('#customer-tab tbody tr');
            rows.forEach(row => {
                if (filter === 'all') {
                    row.style.display = '';
                } else if (filter === 'overdue') {
                    row.style.display = row.classList.contains('overdue') ? '' : 'none';
                } else if (filter === 'due-soon') {
                    row.style.display = row.classList.contains('due-soon') ? '' : 'none';
                }
            });
        }
    </script>
    
    <style>
        .tab-button:hover {
            color: var(--text) !important;
        }
    </style>
}

