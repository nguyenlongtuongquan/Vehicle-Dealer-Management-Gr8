@page
@model Vehicle_Dealer_Management.Pages.EVM.PricePoliciesModel
@{
    ViewData["Title"] = "Quản lý chính sách giá";
    ViewData["UserRole"] = "EVM_STAFF";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "EVM Staff";
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Quản lý chính sách giá</h1>
            <p class="content-subtitle">Thiết lập giá bán lẻ và giá sỉ cho từng mẫu xe</p>
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display='block'">
            <i class="bi bi-plus-circle"></i> Tạo chính sách mới
        </button>
    </div>
</div>

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="grid grid-cols-3 gap-2">
            <div class="form-group mb-0">
                <select class="form-control">
                    <option>Tất cả mẫu xe</option>
                    @foreach (var v in Model.AllVehicles)
                    {
                        <option>@v</option>
                    }
                </select>
            </div>
            <div class="form-group mb-0">
                <select class="form-control">
                    <option>Tất cả đại lý</option>
                    <option>Giá chung (Global)</option>
                    @foreach (var d in Model.AllDealers)
                    {
                        <option>@d</option>
                    }
                </select>
            </div>
            <button class="btn btn-primary">
                <i class="bi bi-search"></i> Lọc
            </button>
        </div>
    </div>
</div>

<!-- Price Policies Table -->
<div class="card">
    <div class="card-body">
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th>Mẫu xe</th>
                        <th>Áp dụng cho</th>
                        <th>Giá bán lẻ (MSRP)</th>
                        <th>Giá sỉ</th>
                        <th>Hiệu lực từ</th>
                        <th>Đến</th>
                        <th>Trạng thái</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var policy in Model.PricePolicies)
                    {
                        var isActive = policy.ValidFrom <= DateTime.Now && (policy.ValidTo == null || policy.ValidTo >= DateTime.Now);
                        
                        <tr>
                            <td>
                                <strong>@policy.VehicleName</strong>
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(policy.DealerName))
                                {
                                    <span class="badge badge-info">Giá chung (Global)</span>
                                }
                                else
                                {
                                    <span>@policy.DealerName</span>
                                }
                            </td>
                            <td>
                                @if (policy.OriginalMsrp.HasValue && policy.OriginalMsrp.Value != policy.Msrp)
                                {
                                    <div>
                                        <div style="text-decoration: line-through; color: var(--text-muted); font-size: 0.875rem;">
                                            @policy.OriginalMsrp.Value.ToString("N0") VND
                                        </div>
                                        <div>
                                            <strong style="color: var(--accent-cyan);">@policy.Msrp.ToString("N0") VND</strong>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <strong style="color: var(--accent-cyan);">@policy.Msrp.ToString("N0") VND</strong>
                                }
                            </td>
                            <td>
                                @if (policy.OriginalWholesalePrice.HasValue && policy.OriginalWholesalePrice.Value != policy.WholesalePrice)
                                {
                                    <div>
                                        <div style="text-decoration: line-through; color: var(--text-muted); font-size: 0.875rem;">
                                            @policy.OriginalWholesalePrice.Value.ToString("N0") VND
                                        </div>
                                        <div>
                                            <strong>@policy.WholesalePrice.ToString("N0") VND</strong>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span>@policy.WholesalePrice.ToString("N0") VND</span>
                                }
                            </td>
                            <td>@policy.ValidFrom.ToString("dd/MM/yyyy")</td>
                            <td>@(policy.ValidTo?.ToString("dd/MM/yyyy") ?? "Không giới hạn")</td>
                            <td>
                                @if (isActive)
                                {
                                    <span class="badge badge-success">Đang áp dụng</span>
                                }
                                else if (policy.ValidFrom > DateTime.Now)
                                {
                                    <span class="badge badge-warning">Chưa hiệu lực</span>
                                }
                                else
                                {
                                    <span class="badge badge-default">Hết hạn</span>
                                }
                            </td>
                            <td>
                                <div class="flex gap-1">
                                    <button class="btn btn-secondary btn-sm edit-policy-btn" 
                                            data-policy-id="@policy.Id"
                                            data-vehicle-name="@(policy.VehicleName.Replace("\"", "&quot;"))"
                                            data-msrp="@policy.Msrp"
                                            data-wholesale-price="@policy.WholesalePrice"
                                            data-original-msrp="@(policy.OriginalMsrp?.ToString() ?? policy.Msrp.ToString())"
                                            data-original-wholesale-price="@(policy.OriginalWholesalePrice?.ToString() ?? policy.WholesalePrice.ToString())"
                                            data-valid-from="@policy.ValidFrom.ToString("yyyy-MM-dd")"
                                            data-valid-to="@(policy.ValidTo?.ToString("yyyy-MM-dd") ?? "")"
                                            data-note="@((policy.Note ?? "").Replace("\"", "&quot;").Replace("\r", "").Replace("\n", " "))">
                                        <i class="bi bi-pencil"></i> Sửa
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deletePolicy(@policy.Id, '@Html.Raw(policy.VehicleName.Replace("'", "\\'"))')">
                                        <i class="bi bi-trash"></i> Xóa
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Modal (Simple) -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; margin: auto;">
        <div class="card-header">
            <h3 class="card-title mb-0">Tạo chính sách giá mới</h3>
        </div>
        <div class="card-body">
            <form method="post" id="createPolicyForm">
                @Html.AntiForgeryToken()
                <div class="form-group">
                    <label class="form-label">Mẫu xe</label>
                    <select class="form-control" name="vehicleId" id="createVehicleId" required>
                        <option value="">-- Chọn xe --</option>
                        @foreach (var v in Model.Vehicles)
                        {
                            <option value="@v.Id">@v.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Chọn khuyến mãi (tùy chọn)</label>
                    <select class="form-control" name="promotionId" id="createPromotionId" onchange="onPromotionChange()">
                        <option value="">-- Không chọn khuyến mãi --</option>
                        @foreach (var p in Model.Promotions)
                        {
                            <option value="@p.Id" data-rule='@p.RuleJson'>@p.Name</option>
                        }
                    </select>
                    <small class="form-text">Hoặc nhập % giảm giá trực tiếp bên dưới</small>
                </div>
                <div class="form-group">
                    <label class="form-label">% Giảm giá trực tiếp (tùy chọn)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" class="form-control" id="createDiscountPercent" name="discountPercent" min="0" max="100" step="0.1" placeholder="0" onchange="onDiscountPercentChange()" style="flex: 1;" />
                        <span style="color: var(--text-muted);">%</span>
                    </div>
                    <small class="form-text">Nhập số phần trăm giảm giá (ví dụ: 20 cho 20%). Hệ thống sẽ tự động tính giá cuối cùng.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Giá bán lẻ (MSRP) <span style="color: var(--text-muted);">(giá gốc)</span></label>
                    <input type="number" class="form-control" name="msrp" id="createMsrp" required step="1000000" onchange="calculatePrice()" />
                </div>
                <div class="form-group">
                    <label class="form-label">Giá sỉ <span style="color: var(--text-muted);">(giá gốc)</span></label>
                    <input type="number" class="form-control" name="wholesalePrice" id="createWholesalePrice" required step="1000000" onchange="calculatePrice()" />
                </div>
                <div class="alert alert-info" id="pricePreview" style="display: none; padding: 0.75rem; background: var(--info-bg, rgba(59, 130, 246, 0.1)); border: 1px solid var(--info, #3b82f6); border-radius: var(--radius-sm); color: var(--info, #3b82f6); font-size: 0.875rem;">
                    <strong>Giá sau giảm:</strong><br>
                    <span id="discountedMsrp"></span><br>
                    <span id="discountedWholesale"></span>
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi chú về giá (tùy chọn)</label>
                    <textarea class="form-control" name="note" id="createNote" rows="3" placeholder="Ví dụ: Giá đã bao gồm khuyến mãi 20%. Giá có thể thay đổi tùy theo đại lý..."></textarea>
                    <small class="form-text">Ghi chú này sẽ hiển thị trên trang chi tiết xe để khách hàng xem</small>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">Tạo</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('createModal').style.display='none'">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 600px; width: 90%; margin: 2rem;">
        <div class="card-header">
            <h3 class="card-title mb-0">Chỉnh sửa chính sách giá</h3>
        </div>
        <div class="card-body">
            @if (TempData["EditError"] != null)
            {
                <div class="alert alert-error" style="margin-bottom: 1rem; padding: 0.75rem; background: var(--error-bg); border: 1px solid var(--error); border-radius: var(--radius-sm); color: var(--error);">
                    <i class="bi bi-exclamation-triangle"></i> @TempData["EditError"]
                </div>
            }
            <form method="post" asp-page-handler="UpdatePolicy">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editPolicyId" name="policyId" />
                <div class="form-group">
                    <label class="form-label">Mẫu xe</label>
                    <input type="text" class="form-control" id="editVehicleName" readonly style="background: var(--black); cursor: not-allowed;" />
                </div>
                <div class="form-group">
                    <label class="form-label">% Giảm giá trực tiếp (tùy chọn)</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="number" class="form-control" id="editDiscountPercent" name="discountPercent" min="0" max="100" step="0.1" placeholder="0" onchange="calculateEditPrice()" style="flex: 1;" />
                        <span style="color: var(--text-muted);">%</span>
                    </div>
                    <small class="form-text">Nhập % giảm giá để tự động tính giá cuối cùng</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Giá bán lẻ (MSRP) <span style="color: var(--text-muted);">(giá gốc)</span></label>
                    <input type="number" class="form-control" id="editMsrp" name="msrp" required step="1000000" onchange="calculateEditPrice()" />
                </div>
                <div class="form-group">
                    <label class="form-label">Giá sỉ <span style="color: var(--text-muted);">(giá gốc)</span></label>
                    <input type="number" class="form-control" id="editWholesalePrice" name="wholesalePrice" required step="1000000" onchange="calculateEditPrice()" />
                </div>
                <div class="alert alert-info" id="editPricePreview" style="display: none; padding: 0.75rem; background: var(--info-bg, rgba(59, 130, 246, 0.1)); border: 1px solid var(--info, #3b82f6); border-radius: var(--radius-sm); color: var(--info, #3b82f6); font-size: 0.875rem;">
                    <strong>Giá sau giảm:</strong><br>
                    <span id="editDiscountedMsrp"></span><br>
                    <span id="editDiscountedWholesale"></span>
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi chú về giá (tùy chọn)</label>
                    <textarea class="form-control" name="note" id="editNote" rows="3" placeholder="Ví dụ: Giá đã bao gồm khuyến mãi 20%. Giá có thể thay đổi tùy theo đại lý..."></textarea>
                    <small class="form-text">Ghi chú này sẽ hiển thị trên trang chi tiết xe để khách hàng xem</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Hiệu lực từ</label>
                    <input type="date" class="form-control" id="editValidFrom" name="validFrom" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Đến (tùy chọn)</label>
                    <input type="date" class="form-control" id="editValidTo" name="validTo" />
                    <small class="form-text">Để trống nếu không có ngày hết hạn</small>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('editModal').style.display='none'">Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div id="successToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1rem 1.5rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius); color: var(--success); box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <i class="bi bi-check-circle"></i> @TempData["Success"]
    </div>
    <script>
        setTimeout(function() {
            var toast = document.getElementById('successToast');
            if (toast) toast.style.display = 'none';
        }, 3000);
    </script>
}

@section Scripts {
    <script>
        function getDiscountPercent() {
            // Ưu tiên % giảm giá trực tiếp, nếu không có thì lấy từ promotion
            var discountInput = document.getElementById('createDiscountPercent');
            if (discountInput && discountInput.value && parseFloat(discountInput.value) > 0) {
                return parseFloat(discountInput.value);
            }

            // Nếu không có input trực tiếp, lấy từ promotion
            var promotionSelect = document.getElementById('createPromotionId');
            if (promotionSelect && promotionSelect.value) {
                var selectedOption = promotionSelect.options[promotionSelect.selectedIndex];
                var ruleJson = selectedOption.getAttribute('data-rule');
                
                if (ruleJson) {
                    try {
                        var rule = JSON.parse(ruleJson);
                        return rule.discountPercent || 0;
                    } catch (e) {
                        return 0;
                    }
                }
            }

            return 0;
        }

        function calculatePrice() {
            var msrpInput = document.getElementById('createMsrp');
            var wholesaleInput = document.getElementById('createWholesalePrice');
            var previewDiv = document.getElementById('pricePreview');
            var discountedMsrpSpan = document.getElementById('discountedMsrp');
            var discountedWholesaleSpan = document.getElementById('discountedWholesale');

            if (!msrpInput.value || !wholesaleInput.value) {
                previewDiv.style.display = 'none';
                return;
            }

            var discountPercent = getDiscountPercent();
            
            if (discountPercent > 0) {
                var originalMsrp = parseFloat(msrpInput.value);
                var originalWholesale = parseFloat(wholesaleInput.value);
                
                var discountedMsrp = originalMsrp * (1 - discountPercent / 100);
                var discountedWholesale = originalWholesale * (1 - discountPercent / 100);
                
                discountedMsrpSpan.textContent = 'MSRP: ' + originalMsrp.toLocaleString('vi-VN') + ' VND → ' + discountedMsrp.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                discountedWholesaleSpan.textContent = 'Giá sỉ: ' + originalWholesale.toLocaleString('vi-VN') + ' VND → ' + discountedWholesale.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function onPromotionChange() {
            // Khi chọn promotion, clear input % giảm giá trực tiếp
            var discountInput = document.getElementById('createDiscountPercent');
            if (discountInput) {
                discountInput.value = '';
            }
            calculatePrice();
        }

        function onDiscountPercentChange() {
            // Khi nhập % trực tiếp, clear promotion selection
            var promotionSelect = document.getElementById('createPromotionId');
            if (promotionSelect) {
                promotionSelect.value = '';
            }
            calculatePrice();
        }

        function calculateEditPrice() {
            var discountInput = document.getElementById('editDiscountPercent');
            var msrpInput = document.getElementById('editMsrp');
            var wholesaleInput = document.getElementById('editWholesalePrice');
            var previewDiv = document.getElementById('editPricePreview');
            var discountedMsrpSpan = document.getElementById('editDiscountedMsrp');
            var discountedWholesaleSpan = document.getElementById('editDiscountedWholesale');

            if (!msrpInput.value || !wholesaleInput.value) {
                previewDiv.style.display = 'none';
                return;
            }

            var discountPercent = discountInput && discountInput.value ? parseFloat(discountInput.value) : 0;
            
            if (discountPercent > 0) {
                var originalMsrp = parseFloat(msrpInput.value);
                var originalWholesale = parseFloat(wholesaleInput.value);
                
                var discountedMsrp = originalMsrp * (1 - discountPercent / 100);
                var discountedWholesale = originalWholesale * (1 - discountPercent / 100);
                
                discountedMsrpSpan.textContent = 'MSRP: ' + originalMsrp.toLocaleString('vi-VN') + ' VND → ' + discountedMsrp.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                discountedWholesaleSpan.textContent = 'Giá sỉ: ' + originalWholesale.toLocaleString('vi-VN') + ' VND → ' + discountedWholesale.toLocaleString('vi-VN') + ' VND (giảm ' + discountPercent + '%)';
                previewDiv.style.display = 'block';
            } else {
                previewDiv.style.display = 'none';
            }
        }

        function openEditModal(button) {
            try {
                var id = button.getAttribute('data-policy-id');
                var vehicleName = button.getAttribute('data-vehicle-name') || '';
                var msrp = button.getAttribute('data-msrp') || '0'; // Giá cuối (sau discount)
                var wholesalePrice = button.getAttribute('data-wholesale-price') || '0'; // Giá cuối (sau discount)
                var originalMsrp = button.getAttribute('data-original-msrp') || msrp; // Giá gốc
                var originalWholesalePrice = button.getAttribute('data-original-wholesale-price') || wholesalePrice; // Giá sỉ gốc
                var validFrom = button.getAttribute('data-valid-from') || '';
                var validTo = button.getAttribute('data-valid-to') || '';
                var note = button.getAttribute('data-note') || '';

                // Decode HTML entities
                vehicleName = vehicleName.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
                note = note.replace(/&quot;/g, '"').replace(/&#39;/g, "'");

                var editPolicyId = document.getElementById('editPolicyId');
                var editVehicleName = document.getElementById('editVehicleName');
                var editMsrp = document.getElementById('editMsrp');
                var editWholesalePrice = document.getElementById('editWholesalePrice');
                var editDiscountPercent = document.getElementById('editDiscountPercent');
                var editNote = document.getElementById('editNote');
                var editValidFrom = document.getElementById('editValidFrom');
                var editValidTo = document.getElementById('editValidTo');
                var editPricePreview = document.getElementById('editPricePreview');
                var editModal = document.getElementById('editModal');

                if (!editPolicyId || !editVehicleName || !editMsrp || !editWholesalePrice || !editModal) {
                    console.error('Edit modal elements not found');
                    alert('Có lỗi xảy ra. Vui lòng tải lại trang.');
                    return;
                }

                editPolicyId.value = id;
                editVehicleName.value = vehicleName;
                
                // Điền giá gốc vào input (không phải giá cuối)
                editMsrp.value = originalMsrp;
                editWholesalePrice.value = originalWholesalePrice;
                
                // Tính discount phần trăm nếu có
                var originalMsrpNum = parseFloat(originalMsrp);
                var msrpNum = parseFloat(msrp);
                if (originalMsrpNum > 0 && originalMsrpNum !== msrpNum) {
                    var discountPercent = ((originalMsrpNum - msrpNum) / originalMsrpNum) * 100;
                    if (editDiscountPercent) editDiscountPercent.value = discountPercent.toFixed(1);
                } else {
                    if (editDiscountPercent) editDiscountPercent.value = '';
                }
                
                if (editNote) editNote.value = note;
                if (editValidFrom) editValidFrom.value = validFrom;
                if (editValidTo) editValidTo.value = validTo;
                
                // Cập nhật preview nếu có discount
                if (editPricePreview && editDiscountPercent && editDiscountPercent.value) {
                    calculateEditPrice();
                } else {
                    if (editPricePreview) editPricePreview.style.display = 'none';
                }
                
                editModal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Có lỗi xảy ra khi mở form chỉnh sửa: ' + error.message);
            }
        }

        // Attach event listeners to all edit buttons
        document.addEventListener('DOMContentLoaded', function() {
            var editButtons = document.querySelectorAll('.edit-policy-btn');
            editButtons.forEach(function(button) {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    openEditModal(this);
                });
            });
        });

        function deletePolicy(id, vehicleName) {
            if (confirm('Bạn có chắc chắn muốn xóa chính sách giá cho "' + vehicleName + '"? Hành động này không thể hoàn tác.')) {
                var form = document.createElement('form');
                form.method = 'post';
                form.action = '?handler=DeletePolicy';
                
                var token = document.querySelector('input[name="__RequestVerificationToken"]');
                if (token) {
                    var tokenInput = token.cloneNode(true);
                    form.appendChild(tokenInput);
                }
                
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'policyId';
                input.value = id;
                
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Close modal when clicking outside
        document.getElementById('createModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // Auto-open edit modal if there's an error
        @if (TempData["EditError"] != null)
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                var editModal = document.getElementById('editModal');
                if (editModal) {
                    editModal.style.display = 'flex';
                }
            });
            </text>
        }

        // Close edit modal when clicking outside
        document.getElementById('editModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    </script>
}

