@page
@model Vehicle_Dealer_Management.Pages.Dealer.TestDrivesModel
@{
    ViewData["Title"] = "Qu·∫£n l√Ω l·ªãch l√°i th·ª≠";
    ViewData["UserRole"] = "DEALER_STAFF";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "Dealer Staff";
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Qu·∫£n l√Ω l·ªãch l√°i th·ª≠</h1>
            <p class="content-subtitle">Xem v√† x√°c nh·∫≠n l·ªãch h·∫πn l√°i th·ª≠ xe</p>
        </div>
        <button class="btn btn-primary" onclick="document.getElementById('createModal').style.display='flex'">
            <i class="bi bi-calendar-plus"></i> ƒê·∫∑t l·ªãch m·ªõi
        </button>
    </div>
</div>

@if (TempData["DebugInfo"] != null)
{
    <div class="alert alert-warning" style="margin-bottom: 1rem; padding: 1rem; background: var(--warning-bg); border: 1px solid var(--warning); border-radius: var(--radius-sm); color: var(--warning);">
        <i class="bi bi-exclamation-triangle"></i> @TempData["DebugInfo"]
    </div>
}

<!-- Stats -->
<div class="grid grid-cols-4 mb-4">
    <div class="stat-card">
        <div class="stat-label">L·ªãch h√¥m nay</div>
        <div class="stat-value" style="color: var(--accent-cyan);">@Model.TodayCount</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ch·ªù x√°c nh·∫≠n</div>
        <div class="stat-value" style="color: var(--warning);">@Model.RequestedCount</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ƒê√£ x√°c nh·∫≠n</div>
        <div class="stat-value" style="color: var(--success);">@Model.ConfirmedCount</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Ho√†n th√†nh</div>
        <div class="stat-value">@Model.DoneCount</div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="card mb-4">
    <div class="card-body" style="padding: 0;">
        <div style="display: flex; border-bottom: 1px solid var(--border);">
            <a href="?filter=all" class="tab-btn @(Model.Filter == "all" ? "active" : "")" style="padding: 1rem 2rem; text-decoration: none; color: inherit; border-bottom: 2px solid @(Model.Filter == "all" ? "var(--accent-cyan)" : "transparent");">
                T·∫•t c·∫£
            </a>
            <a href="?filter=today" class="tab-btn @(Model.Filter == "today" ? "active" : "")" style="padding: 1rem 2rem; text-decoration: none; color: inherit; border-bottom: 2px solid @(Model.Filter == "today" ? "var(--accent-cyan)" : "transparent");">
                H√¥m nay
            </a>
            <a href="?filter=requested" class="tab-btn @(Model.Filter == "requested" ? "active" : "")" style="padding: 1rem 2rem; text-decoration: none; color: inherit; border-bottom: 2px solid @(Model.Filter == "requested" ? "var(--accent-cyan)" : "transparent");">
                Ch·ªù x√°c nh·∫≠n
            </a>
            <a href="?filter=upcoming" class="tab-btn @(Model.Filter == "upcoming" ? "active" : "")" style="padding: 1rem 2rem; text-decoration: none; color: inherit; border-bottom: 2px solid @(Model.Filter == "upcoming" ? "var(--accent-cyan)" : "transparent");">
                S·∫Øp t·ªõi
            </a>
        </div>
    </div>
</div>

<!-- Test Drives List -->
<div class="card">
    <div class="card-body">
        @if (Model.TestDrives.Any())
        {
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>M·∫´u xe</th>
                            <th>Th·ªùi gian</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ghi ch√∫</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var td in Model.TestDrives)
                        {
                            var isToday = td.ScheduleTime.Date == DateTime.Today;
                            
                            <tr style="@(isToday ? "background: var(--info-bg);" : "")">
                                <td><strong>#@td.Id</strong></td>
                                <td>
                                    <div><strong>@td.CustomerName</strong></div>
                                    <div class="text-muted" style="font-size: 0.875rem;">@td.CustomerPhone</div>
                                </td>
                                <td>@td.VehicleName</td>
                                <td>
                                    <div><strong>@td.ScheduleTime.ToString("dd/MM/yyyy")</strong></div>
                                    <div style="color: var(--accent-cyan); font-size: 0.875rem;">@td.ScheduleTime.ToString("HH:mm")</div>
                                </td>
                                <td>@await Html.PartialAsync("_StatusBadge", td.Status)</td>
                                <td class="text-muted" style="font-size: 0.875rem;">@td.Note</td>
                                <td>
                                    @if (td.Status == "REQUESTED")
                                    {
                                        <form method="post" asp-page-handler="Confirm" style="display: inline;">
                                            <input type="hidden" name="id" value="@td.Id" />
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-check"></i> X√°c nh·∫≠n
                                            </button>
                                        </form>
                                    }
                                    else if (td.Status == "CONFIRMED")
                                    {
                                        <form method="post" asp-page-handler="MarkDone" style="display: inline;">
                                            <input type="hidden" name="id" value="@td.Id" />
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-check-circle"></i> Ho√†n th√†nh
                                            </button>
                                        </form>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <div class="empty-state-title">Kh√¥ng c√≥ l·ªãch l√°i th·ª≠</div>
                <div class="empty-state-text">Ch∆∞a c√≥ l·ªãch h·∫πn n√†o</div>
            </div>
        }
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card" style="max-width: 500px; width: 90%;">
        <div class="card-header">
            <h3 class="card-title mb-0">ƒê·∫∑t l·ªãch l√°i th·ª≠ m·ªõi</h3>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="Create">
                <div class="form-group">
                    <label class="form-label">Kh√°ch h√†ng</label>
                    <select class="form-control" name="customerId" required>
                        <option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
                        @foreach (var c in Model.AllCustomers)
                        {
                            <option value="@c.Id">@c.Name - @c.Phone</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">M·∫´u xe</label>
                    <select class="form-control" name="vehicleId" required>
                        <option value="">-- Ch·ªçn xe --</option>
                        @foreach (var v in Model.AllVehicles)
                        {
                            <option value="@v.Id">@v.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Ng√†y l√°i th·ª≠</label>
                    <input type="date" class="form-control" name="date" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Gi·ªù</label>
                    <input type="time" class="form-control" name="time" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Ghi ch√∫</label>
                    <textarea class="form-control" name="note" rows="2"></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">T·∫°o l·ªãch</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('createModal').style.display='none'">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .tab-btn:hover { background: rgba(255,255,255,0.05); }
    </style>
}

