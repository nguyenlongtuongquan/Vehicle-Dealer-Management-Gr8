@page
@model Vehicle_Dealer_Management.Pages.DealerManager.Reports.SalesByStaffModel
@{
    ViewData["Title"] = "B√°o c√°o doanh s·ªë theo nh√¢n vi√™n";
    ViewData["UserRole"] = "DEALER_MANAGER";
    ViewData["UserName"] = HttpContext.Session.GetString("UserName") ?? "Manager";
}

<div class="content-header">
    <h1 class="content-title">B√°o c√°o doanh s·ªë theo nh√¢n vi√™n</h1>
    <p class="content-subtitle">ƒê√°nh gi√° hi·ªáu su·∫•t b√°n h√†ng c·ªßa t·ª´ng nh√¢n vi√™n</p>
</div>

<!-- Filter Card -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get">
            <div class="grid grid-cols-4 gap-2">
                <div class="form-group mb-0">
                    <label class="form-label">T·ª´ ng√†y</label>
                    <input type="date" class="form-control" name="fromDate" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">ƒê·∫øn ng√†y</label>
                    <input type="date" class="form-control" name="toDate" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
                </div>
                <div class="form-group mb-0">
                    <label class="form-label">Nh√¢n vi√™n</label>
                    <select class="form-control" name="staffId">
                        <option value="">T·∫•t c·∫£</option>
                        @foreach (var staff in Model.AllStaff)
                        {
                            <option value="@staff.Id" selected="@(Model.StaffId == staff.Id)">@staff.Name</option>
                        }
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="bi bi-search"></i> L·ªçc
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="grid grid-cols-4 mb-4">
    <div class="stat-card">
        <div class="stat-label">T·ªïng doanh s·ªë</div>
        <div class="stat-value">@Model.TotalSales.ToString("N0")</div>
        <div class="text-muted" style="font-size: 0.875rem;">VND</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">S·ªë ƒë∆°n h√†ng</div>
        <div class="stat-value">@Model.TotalOrders</div>
        <div class="text-muted" style="font-size: 0.875rem;">ƒê∆°n</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">S·ªë xe ƒë√£ b√°n</div>
        <div class="stat-value">@Model.TotalVehiclesSold</div>
        <div class="text-muted" style="font-size: 0.875rem;">Xe</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Doanh s·ªë TB/NV</div>
        <div class="stat-value">@((Model.StaffReports.Any() ? Model.TotalSales / Model.StaffReports.Count : 0).ToString("N0"))</div>
        <div class="text-muted" style="font-size: 0.875rem;">VND</div>
    </div>
</div>

<!-- Staff Performance Table -->
<div class="card">
    <div class="card-header">
        <div class="flex justify-between items-center">
            <h3 class="card-title mb-0">Hi·ªáu su·∫•t nh√¢n vi√™n</h3>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">
                <i class="bi bi-printer"></i> In b√°o c√°o
            </button>
        </div>
    </div>
    <div class="card-body">
        @if (Model.StaffReports.Any())
        {
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Nh√¢n vi√™n</th>
                            <th>Email</th>
                            <th>S·ªë ƒë∆°n</th>
                            <th>Xe ƒë√£ b√°n</th>
                            <th>Doanh s·ªë</th>
                            <th>TB/ƒê∆°n</th>
                            <th>% ƒê√≥ng g√≥p</th>
                            <th>X·∫øp h·∫°ng</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.StaffReports.Count; i++)
                        {
                            var staff = Model.StaffReports[i];
                            var contributionPercent = Model.TotalSales > 0 ? (staff.Sales / Model.TotalSales * 100) : 0;
                            
                            <tr>
                                <td>@(i + 1)</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="user-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">
                                            @staff.Name.Substring(0, 1).ToUpper()
                                        </div>
                                        <strong>@staff.Name</strong>
                                    </div>
                                </td>
                                <td class="text-muted">@staff.Email</td>
                                <td><strong>@staff.OrderCount</strong></td>
                                <td>@staff.VehiclesSold</td>
                                <td><strong style="color: var(--accent-cyan);">@staff.Sales.ToString("N0") VND</strong></td>
                                <td>@staff.AvgOrderValue.ToString("N0") VND</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div style="width: 80px; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden;">
                                            <div style="width: @contributionPercent.ToString("F1")%; height: 100%; background: var(--success);"></div>
                                        </div>
                                        <span>@contributionPercent.ToString("F1")%</span>
                                    </div>
                                </td>
                                <td>
                                    @if (staff.Rank == 1)
                                    {
                                        <span class="badge badge-success">üèÜ #@staff.Rank</span>
                                    }
                                    else if (staff.Rank <= 3)
                                    {
                                        <span class="badge badge-info">#@staff.Rank</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-default">#@staff.Rank</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                    <tfoot style="background: var(--surface); border-top: 2px solid var(--border); font-weight: 600;">
                        <tr>
                            <td colspan="3">T·ªîNG C·ªòNG</td>
                            <td><strong>@Model.TotalOrders</strong></td>
                            <td><strong>@Model.TotalVehiclesSold</strong></td>
                            <td><strong style="color: var(--accent-cyan);">@Model.TotalSales.ToString("N0") VND</strong></td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-title">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
                <div class="empty-state-text">Ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem b√°o c√°o</div>
            </div>
        }
    </div>
</div>

<!-- Top Performers Section -->
@if (Model.StaffReports.Any())
{
    <div class="grid grid-cols-3 mt-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">üèÜ Top doanh s·ªë</h3>
            </div>
            <div class="card-body">
                @foreach (var staff in Model.StaffReports.OrderByDescending(s => s.Sales).Take(3))
                {
                    <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid var(--border-subtle);">
                        <div>
                            <div><strong>@staff.Name</strong></div>
                            <div class="text-muted" style="font-size: 0.875rem;">@staff.OrderCount ƒë∆°n</div>
                        </div>
                        <div class="text-right">
                            <div style="color: var(--accent-cyan); font-weight: 600;">@staff.Sales.ToString("N0")</div>
                            <div class="text-muted" style="font-size: 0.875rem;">VND</div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">üìà S·ªë ƒë∆°n nhi·ªÅu nh·∫•t</h3>
            </div>
            <div class="card-body">
                @foreach (var staff in Model.StaffReports.OrderByDescending(s => s.OrderCount).Take(3))
                {
                    <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid var(--border-subtle);">
                        <div>
                            <div><strong>@staff.Name</strong></div>
                            <div class="text-muted" style="font-size: 0.875rem;">@staff.VehiclesSold xe</div>
                        </div>
                        <div class="text-right">
                            <div style="color: var(--success); font-weight: 600; font-size: 1.5rem;">@staff.OrderCount</div>
                            <div class="text-muted" style="font-size: 0.875rem;">ƒê∆°n</div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">üíé Gi√° tr·ªã TB/ƒê∆°n cao</h3>
            </div>
            <div class="card-body">
                @foreach (var staff in Model.StaffReports.OrderByDescending(s => s.AvgOrderValue).Take(3))
                {
                    <div class="flex justify-between items-center mb-3 pb-3" style="border-bottom: 1px solid var(--border-subtle);">
                        <div>
                            <div><strong>@staff.Name</strong></div>
                            <div class="text-muted" style="font-size: 0.875rem;">@staff.OrderCount ƒë∆°n</div>
                        </div>
                        <div class="text-right">
                            <div style="color: var(--warning); font-weight: 600;">@staff.AvgOrderValue.ToString("N0")</div>
                            <div class="text-muted" style="font-size: 0.875rem;">VND/ƒê∆°n</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@section Scripts {
    <style>
        @@media print {
            .sidebar, .header, .btn, .form-group { display: none !important; }
            .content { padding: 1rem; }
            .card { break-inside: avoid; }
        }
    </style>
}

