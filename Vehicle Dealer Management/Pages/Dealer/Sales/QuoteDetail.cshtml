@page "/Dealer/Sales/QuoteDetail"
@model Vehicle_Dealer_Management.Pages.Dealer.Sales.QuoteDetailModel
@{
    ViewData["Title"] = "Chi ti·∫øt b√°o gi√°";
    // UserRole and UserName are set in code-behind from Session
}

@await Html.PartialAsync("_PageHeader")

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Chi ti·∫øt b√°o gi√° @Model.Quote.QuoteNumber</h1>
            <p class="content-subtitle">M√£ b√°o gi√°: #@Model.Quote.Id</p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <a href="/Dealer/Sales/Quotes" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Quay l·∫°i
            </a>
            @if (Model.Quote.Status == "ACCEPTED" && Model.Contract == null)
            {
                <form method="post" asp-page-handler="CreateContract" style="display: inline;">
                    <input type="hidden" name="id" value="@Model.Quote.Id" />
                    <button type="submit" class="btn btn-outline-primary" onclick="return confirm('T·∫°o h·ª£p ƒë·ªìng v√† g·ª≠i cho kh√°ch h√†ng k√Ω?');">
                        <i class="bi bi-file-text"></i> T·∫°o h·ª£p ƒë·ªìng
                    </button>
                </form>
            }
            @if (Model.Quote.Status == "ACCEPTED" && !Model.Quote.IsConverted)
            {
                var canConvert = Model.Contract != null && (Model.Contract.Status == "SIGNED" || Model.Contract.Status == "ORDER_CREATED");
                if (canConvert)
                {
                    <form method="post" asp-page-handler="ConvertToOrder" style="display: inline;">
                        <input type="hidden" name="id" value="@Model.Quote.Id" />
                        <button type="submit" class="btn btn-primary" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn b√°o gi√° n√†y th√†nh ƒë∆°n h√†ng? ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c t·∫°o v·ªõi tr·∫°ng th√°i OPEN v√† t·∫•t c·∫£ th√¥ng tin t·ª´ b√°o gi√° s·∫Ω ƒë∆∞·ª£c sao ch√©p.');">
                            <i class="bi bi-file-earmark-check"></i> Chuy·ªÉn th√†nh ƒë∆°n h√†ng
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-primary" disabled title="C·∫ßn h·ª£p ƒë·ªìng ƒë√£ k√Ω tr∆∞·ªõc khi chuy·ªÉn th√†nh ƒë∆°n h√†ng.">
                        <i class="bi bi-file-earmark-lock"></i> Chuy·ªÉn th√†nh ƒë∆°n h√†ng
                    </button>
                }
            }
        </div>
    </div>
</div>

<!-- Quote Status & Summary -->
<div class="grid grid-cols-3 mb-4">
    <div class="stat-card">
        <div class="stat-label">Tr·∫°ng th√°i</div>
        <div>@await Html.PartialAsync("_StatusBadge", Model.Quote.Status)</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">T·ªïng ti·ªÅn</div>
        <div class="stat-value">@Model.Quote.TotalAmount.ToString("N0") VND</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">S·ªë l∆∞·ª£ng xe</div>
        <div class="stat-value" style="color: var(--accent-cyan);">@Model.Quote.Items.Count xe</div>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <!-- Left Column: Quote Info & Items -->
    <div>
        <!-- Quote Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Th√¥ng tin b√°o gi√°</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Ng√†y t·∫°o</div>
                        <div>@Model.Quote.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                    @if (Model.Quote.UpdatedAt.HasValue)
                    {
                        <div>
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</div>
                            <div>@Model.Quote.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Ng∆∞·ªùi t·∫°o</div>
                        <div>@Model.Quote.CreatedBy</div>
                    </div>
                    @if (Model.Quote.PromotionName != null)
                    {
                        <div>
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Khuy·∫øn m√£i</div>
                            <div style="color: var(--success);">@Model.Quote.PromotionName</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Th√¥ng tin kh√°ch h√†ng</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">T√™n kh√°ch h√†ng</div>
                        <div><strong>@Model.Quote.CustomerName</strong></div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">S·ªë ƒëi·ªán tho·∫°i</div>
                        <div>@Model.Quote.CustomerPhone</div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Email</div>
                        <div>@Model.Quote.CustomerEmail</div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">ƒê·ªãa ch·ªâ</div>
                        <div>@Model.Quote.CustomerAddress</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quote Items -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Danh s√°ch xe (@Model.Quote.Items.Count xe)</h3>
            </div>
            <div class="card-body" style="padding: 0;">
                @if (Model.Quote.Items.Any())
                {
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Xe</th>
                                    <th>M√†u</th>
                                    <th>SL</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>Gi·∫£m gi√°</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Quote.Items)
                                {
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                @if (!string.IsNullOrEmpty(item.VehicleImageUrl))
                                                {
                                                    <img src="@item.VehicleImageUrl" alt="@item.VehicleModel" 
                                                         style="width: 60px; height: 60px; object-fit: cover; border-radius: var(--radius-sm);" />
                                                }
                                                <div>
                                                    <div><strong>@item.VehicleModel</strong></div>
                                                    <div class="text-muted" style="font-size: 0.875rem;">@item.VehicleVariant</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@item.ColorCode</td>
                                        <td>@item.Qty</td>
                                        <td>@item.UnitPrice.ToString("N0")</td>
                                        <td style="color: var(--success);">-@item.DiscountValue.ToString("N0")</td>
                                        <td><strong>@item.LineTotal.ToString("N0")</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr style="border-top: 2px solid var(--border);">
                                    <td colspan="5" style="text-align: right;"><strong>T·ªïng c·ªông:</strong></td>
                                    <td><strong style="font-size: 1.125rem;">@Model.Quote.SubTotal.ToString("N0") VND</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <div class="empty-state-title">Ch∆∞a c√≥ xe n√†o trong b√°o gi√°</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Column: Actions & Notes -->
    <div>
        <!-- Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Thao t√°c</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 gap-2">
                    @if (Model.Quote.Status == "ACCEPTED" && Model.Contract == null)
                    {
                        <form method="post" asp-page-handler="CreateContract" style="width: 100%;">
                            <input type="hidden" name="id" value="@Model.Quote.Id" />
                            <button type="submit" class="btn btn-outline-primary" style="width: 100%;" onclick="return confirm('T·∫°o h·ª£p ƒë·ªìng v√† g·ª≠i cho kh√°ch h√†ng k√Ω?');">
                                <i class="bi bi-file-text"></i> T·∫°o h·ª£p ƒë·ªìng
                            </button>
                        </form>
                    }
                    @if (Model.Contract != null)
                    {
                        <div class="alert alert-info" style="margin-bottom: 0;">
                            <div><strong>H·ª£p ƒë·ªìng:</strong> #@Model.Contract.Id</div>
                            <div>Tr·∫°ng th√°i: @await Html.PartialAsync("_StatusBadge", Model.Contract.Status)</div>
                            @if (Model.Contract.CustomerSignedAt.HasValue)
                            {
                                <div>Kh√°ch h√†ng k√Ω: @Model.Contract.CustomerSignedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                            }
                            else
                            {
                                <div>ƒêang ch·ªù kh√°ch h√†ng t·∫£i ch·ªØ k√Ω.</div>
                            }
                            @if (!string.IsNullOrEmpty(Model.Contract.CustomerSignatureUrl))
                            {
                                <a href="@Model.Contract.CustomerSignatureUrl" target="_blank">Xem ch·ªØ k√Ω</a>
                            }
                        </div>
                    }
                    @if (Model.Quote.Status == "ACCEPTED" && !Model.Quote.IsConverted)
                    {
                        var canConvert = Model.Contract != null && (Model.Contract.Status == "SIGNED" || Model.Contract.Status == "ORDER_CREATED");
                        if (canConvert)
                        {
                            <form method="post" asp-page-handler="ConvertToOrder" style="width: 100%;">
                                <input type="hidden" name="id" value="@Model.Quote.Id" />
                                <button type="submit" class="btn btn-primary" style="width: 100%;" onclick="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn b√°o gi√° n√†y th√†nh ƒë∆°n h√†ng? ƒê∆°n h√†ng s·∫Ω ƒë∆∞·ª£c t·∫°o v·ªõi tr·∫°ng th√°i OPEN v√† t·∫•t c·∫£ th√¥ng tin t·ª´ b√°o gi√° s·∫Ω ƒë∆∞·ª£c sao ch√©p.');">
                                    <i class="bi bi-file-earmark-check"></i> Chuy·ªÉn th√†nh ƒë∆°n h√†ng
                                </button>
                            </form>
                        }
                        else
                        {
                            <button class="btn btn-primary" style="width: 100%;" disabled title="C·∫ßn h·ª£p ƒë·ªìng ƒë√£ k√Ω tr∆∞·ªõc khi chuy·ªÉn th√†nh ƒë∆°n h√†ng.">
                                <i class="bi bi-file-earmark-lock"></i> Chuy·ªÉn th√†nh ƒë∆°n h√†ng
                            </button>
                        }
                    }
                    else if (Model.Quote.Status != "ACCEPTED" && !Model.Quote.IsConverted)
                    {
                        <div class="alert alert-warning" style="width: 100%; margin-bottom: 0.5rem;">
                            <i class="bi bi-exclamation-triangle"></i> Ch·ªâ c√≥ th·ªÉ chuy·ªÉn th√†nh ƒë∆°n h√†ng khi kh√°ch h√†ng ƒë√£ ch·∫•p nh·∫≠n b√°o gi√°.
                        </div>
                    }
                    @if ((Model.Quote.Status == "DRAFT" || Model.Quote.Status == "SENT") && !Model.Quote.IsConverted)
                    {
                        <a href="/Dealer/Sales/EditQuote?id=@Model.Quote.Id" class="btn btn-secondary" style="width: 100%;">
                            <i class="bi bi-pencil"></i> Ch·ªânh s·ª≠a b√°o gi√°
                        </a>
                    }
                    @if (Model.Quote.IsConverted || Model.Quote.Status == "CONVERTED")
                    {
                        <div class="alert alert-info" style="width: 100%; margin-bottom: 0.5rem;">
                            <i class="bi bi-info-circle"></i> B√°o gi√° n√†y ƒë√£ ƒë∆∞·ª£c chuy·ªÉn th√†nh ƒë∆°n h√†ng. Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi l·∫°i.
                        </div>
                    }
                    <button class="btn btn-secondary" onclick="window.print()" style="width: 100%;">
                        <i class="bi bi-printer"></i> In b√°o gi√°
                    </button>
                </div>
            </div>
        </div>

        <!-- Quote Summary -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">T√≥m t·∫Øt</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-1 gap-3">
                    <div style="padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm);">
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.5rem;">T·ªïng gi√° tr·ªã</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-cyan);">
                            @Model.Quote.TotalAmount.ToString("N0") VND
                        </div>
                    </div>
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">S·ªë l∆∞·ª£ng xe</div>
                        <div style="font-size: 1.25rem; font-weight: 600;">@Model.Quote.Items.Count xe</div>
                    </div>
                    @if (Model.Quote.PromotionName != null)
                    {
                        <div style="padding: 1rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius-sm);">
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Khuy·∫øn m√£i √°p d·ª•ng</div>
                            <div style="color: var(--success); font-weight: 600;">@Model.Quote.PromotionName</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div id="successToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1rem 1.5rem; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius); color: var(--success); box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <i class="bi bi-check-circle"></i> @TempData["Success"]
    </div>
    <script>
        setTimeout(function() {
            var toast = document.getElementById('successToast');
            if (toast) toast.style.display = 'none';
        }, 3000);
    </script>
}

@if (TempData["Error"] != null)
{
    <div id="errorToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999; padding: 1rem 1.5rem; background: var(--error-bg); border: 1px solid var(--error); border-radius: var(--radius); color: var(--error); box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
        <i class="bi bi-exclamation-circle"></i> @TempData["Error"]
    </div>
    <script>
        setTimeout(function() {
            var toast = document.getElementById('errorToast');
            if (toast) toast.style.display = 'none';
        }, 5000);
    </script>
}

@section Scripts {
    <!-- Scripts for toast notifications -->
}

