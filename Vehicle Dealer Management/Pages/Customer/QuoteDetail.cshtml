@page "/Customer/QuoteDetail"
@model Vehicle_Dealer_Management.Pages.Customer.QuoteDetailModel
@{
    ViewData["Title"] = "Chi tiết báo giá";
    // UserRole and UserName are set in code-behind from Session
}

<div class="content-header">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="content-title">Chi tiết báo giá @Model.Quote.QuoteNumber</h1>
            <p class="content-subtitle">Mã báo giá: #@Model.Quote.Id</p>
        </div>
        <a href="/Customer/MyQuotes" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>
    </div>
</div>

<!-- Quote Status & Summary -->
<div class="grid grid-cols-3 mb-4">
    <div class="stat-card">
        <div class="stat-label">Trạng thái</div>
        <div>@await Html.PartialAsync("_StatusBadge", Model.Quote.Status)</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Tổng tiền</div>
        <div class="stat-value">@Model.Quote.TotalAmount.ToString("N0") VND</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Số lượng xe</div>
        <div class="stat-value" style="color: var(--accent-cyan);">@Model.Quote.Items.Count xe</div>
    </div>
</div>

<div class="grid grid-cols-2 gap-4">
    <!-- Left Column: Quote Info & Items -->
    <div>
        <!-- Quote Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Thông tin báo giá</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Ngày tạo</div>
                        <div>@Model.Quote.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                    @if (Model.Quote.UpdatedAt.HasValue)
                    {
                        <div>
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Cập nhật lần cuối</div>
                            <div>@Model.Quote.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (Model.Quote.PromotionName != null)
                    {
                        <div>
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Khuyến mãi</div>
                            <div style="color: var(--success);">@Model.Quote.PromotionName</div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Quote Items -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Danh sách xe</h3>
            </div>
            <div class="card-body">
                @if (Model.Quote.Items.Any())
                {
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Xe</th>
                                    <th>Màu</th>
                                    <th style="text-align: right;">Số lượng</th>
                                    <th style="text-align: right;">Đơn giá</th>
                                    <th style="text-align: right;">Giảm giá</th>
                                    <th style="text-align: right;">Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Quote.Items)
                                {
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>@item.VehicleModel</strong>
                                            </div>
                                            <div class="text-muted" style="font-size: 0.875rem;">@item.VehicleVariant</div>
                                        </td>
                                        <td>@item.ColorCode</td>
                                        <td style="text-align: right;">@item.Qty</td>
                                        <td style="text-align: right;">@item.UnitPrice.ToString("N0") VND</td>
                                        <td style="text-align: right; color: var(--error);">@item.DiscountValue.ToString("N0") VND</td>
                                        <td style="text-align: right; font-weight: 600;">@item.LineTotal.ToString("N0") VND</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="5" style="text-align: right; font-weight: 600; padding-top: 1rem; border-top: 2px solid var(--border);">
                                        Tổng cộng:
                                    </td>
                                    <td style="text-align: right; font-weight: 700; font-size: 1.25rem; color: var(--accent-cyan); padding-top: 1rem; border-top: 2px solid var(--border);">
                                        @Model.Quote.TotalAmount.ToString("N0") VND
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <p class="text-muted">Chưa có xe nào trong báo giá này.</p>
                }
            </div>
        </div>
    </div>

    <!-- Right Column: Dealer Info & Actions -->
    <div>
        <!-- Dealer Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h3 class="card-title">Thông tin đại lý</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem;">
                    <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Tên đại lý</div>
                    <div style="font-weight: 600; font-size: 1.125rem;">@Model.Quote.DealerName</div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Địa chỉ</div>
                    <div>@Model.Quote.DealerAddress</div>
                </div>
                <div>
                    <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Số điện thoại</div>
                    <div>
                        <i class="bi bi-telephone"></i> @Model.Quote.DealerPhone
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        @if (Model.Quote.Status == "SENT" || Model.Quote.Status == "DRAFT")
        {
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Thao tác</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <form method="post" asp-page-handler="Accept" style="margin: 0;">
                            <input type="hidden" name="id" value="@Model.Quote.Id" />
                            <button type="submit" class="btn btn-success" style="width: 100%;" onclick="return confirm('Bạn có chắc chắn muốn chấp nhận báo giá này?');">
                                <i class="bi bi-check-circle"></i> Chấp nhận báo giá
                            </button>
                        </form>
                        <form method="post" asp-page-handler="Reject" style="margin: 0;">
                            <input type="hidden" name="id" value="@Model.Quote.Id" />
                            <button type="submit" class="btn btn-secondary" style="width: 100%;" onclick="return confirm('Bạn có chắc chắn muốn từ chối báo giá này?');">
                                <i class="bi bi-x-circle"></i> Từ chối báo giá
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }

        @if (Model.Contract != null)
        {
            var contractStatus = Model.Contract.Status;
            var canUpload = contractStatus == "PENDING_SIGNATURE";
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Hợp đồng mua xe</h3>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 0.75rem;">
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Mã hợp đồng</div>
                        <div><strong>#@Model.Contract.Id</strong></div>
                    </div>
                    <div style="margin-bottom: 0.75rem;">
                        <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Trạng thái</div>
                        <div>@await Html.PartialAsync("_StatusBadge", contractStatus)</div>
                    </div>
                    @if (Model.Contract.CustomerSignedAt.HasValue)
                    {
                        <div style="margin-bottom: 0.75rem;">
                            <div class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.25rem;">Bạn đã ký lúc</div>
                            <div>@Model.Contract.CustomerSignedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Contract.CustomerSignatureUrl))
                    {
                        <div style="margin-bottom: 0.75rem;">
                            <a href="@Model.Contract.CustomerSignatureUrl" target="_blank" class="btn btn-light">
                                <i class="bi bi-image"></i> Xem ảnh chữ ký
                            </a>
                        </div>
                    }
                    @if (canUpload)
                    {
                        <form method="post" asp-page-handler="UploadSignature" enctype="multipart/form-data">
                            <input type="hidden" name="id" value="@Model.Quote.Id" />
                            <div class="form-group">
                                <label for="signatureFile" class="form-label">Tải ảnh chữ ký (PNG/JPG)</label>
                                <input type="file" name="signatureFile" id="signatureFile" class="form-control" accept=".png,.jpg,.jpeg" required />
                            </div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 0.75rem;">
                                <i class="bi bi-upload"></i> Gửi chữ ký
                            </button>
                            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">Dealer sẽ xác nhận chữ ký trước khi tiếp tục quy trình đặt xe.</p>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-info" style="margin: 0;">
                            Dealer đã ghi nhận hợp đồng này. Vui lòng đợi để tiếp tục các bước tiếp theo.
                        </div>
                    }
                </div>
            </div>
        }
        else if (Model.Quote.Status == "ACCEPTED")
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Hợp đồng mua xe</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" style="margin: 0;">
                        Dealer đang chuẩn bị hợp đồng cho bạn. Vui lòng kiểm tra lại sau.
                    </div>
                </div>
            </div>
        }
    </div>
</div>

